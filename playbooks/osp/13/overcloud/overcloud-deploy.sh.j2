#!/bin/bash

set -o pipefail
set -evx

# overcloud deploy script generated by osp-mnaio
source /home/stack/stackrc
openstack overcloud deploy --templates \
   -n /home/stack/templates/network_data.yaml \
   -r /home/stack/templates/roles/role_data.yaml \
   -e /home/stack/templates/node-info.yaml \
   -e /home/stack/templates/undercloud_ssl_camap.yaml \
   -e /usr/share/openstack-tripleo-heat-templates/environments/network-isolation.yaml \
{% if redhat_overcloud_register | bool %}
   -e /home/stack/templates/rhel-registration/environment-rhel-registration.yaml \
   -e /home/stack/templates/rhel-registration/rhel-registration-resource-registry.yaml \
{% endif %}
{% if enable_ceph_storage | bool %}
   -e /usr/share/openstack-tripleo-heat-templates/environments/ceph-ansible/ceph-ansible.yaml \
   -e /home/stack/templates/ceph-custom-config.yaml \
   -e /home/stack/templates/storage-environment.yaml \
{% if enable_ceph_rgw | bool %}
   -e /usr/share/openstack-tripleo-heat-templates/environments/ceph-ansible/ceph-rgw.yaml \
{% endif %}
{% endif %}
{% if enable_octavia | bool %}
   -e /usr/share/openstack-tripleo-heat-templates/environments/services-docker/octavia.yaml \
{% endif %}
{% if enable_sahara | bool %}
   -e /usr/share/openstack-tripleo-heat-templates/environments/services/sahara.yaml \
{% endif %}
{% if enable_manila | bool %}
   -e /usr/share/openstack-tripleo-heat-templates/environments/manila-{{ manila_backend | default('cephfsnative') }}-config.yaml \
   -e /usr/share/openstack-tripleo-heat-templates/environments/services/ceph-mds.yaml \
   -e /home/stack/templates/manila-{{ manila_backend | default('cephfsnative') }}-config.yaml \
{% endif %}
{% if enable_barbican | bool %}
   -e /usr/share/openstack-tripleo-heat-templates/environments/services/barbican.yaml \
   -e /usr/share/openstack-tripleo-heat-templates/environments/barbican-backend-simple-crypto.yaml \
   -e /home/stack/templates/configure-barbican.yaml \
   -e /home/stack/templates/container-parameters-with-barbican.yaml \
{% else %}
   -e /home/stack/templates/overcloud_images.yaml \
{% endif %}
   -e /usr/share/openstack-tripleo-heat-templates/environments/services-docker/neutron-ovn-ha.yaml \
   --ntp-server pool.ntp.org \
   2>&1 | tee /home/stack/logs/overcloud_install.log

{% if redhat_overcloud_register | bool %}
ANSIBLE_HOST_KEY_CHECKING=False ansible-playbook -i /usr/bin/tripleo-ansible-inventory /home/stack/ansible-osp-registration.yml
{% endif %}
